<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->  
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->  
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->  
<head>
    <title>IoT Asset Management Starter Kit</title>
    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">    
    <link rel="shortcut icon" href="favicon.ico">  
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <!-- Global CSS -->
    <link rel="stylesheet" href="assets/plugins/bootstrap/css/bootstrap.min.css">   
    <!-- Plugins CSS -->    
    <link rel="stylesheet" href="assets/plugins/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="assets/plugins/prism/prism.css">
    <link rel="stylesheet" href="assets/plugins/elegant_font/css/style.css">
    
    <!-- Theme CSS -->
    <link id="theme-style" rel="stylesheet" href="assets/css/styles.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
</head> 

<body class="body-green">
    <div class="page-wrapper">
        <!-- ******Header****** -->
        <header id="header" class="header">
            <div class="container">
                <div class="branding">
                    <h1 class="logo">
                        <a href="index.html">
                            <span aria-hidden="true" class="icon_documents_alt icon"></span>
                            <span class="text-highlight">IoT Asset Management</span>
                        </a>
                    </h1>
                </div><!--//branding-->
                <ol class="breadcrumb">
                    <li><a href="index.html">Home</a></li>
                    <li class="active">Get Started</li>
                </ol>
            </div><!--//container-->
        </header><!--//header-->
        <div class="doc-wrapper">
            <div class="container">
                <div id="doc-header" class="doc-header text-center">
                    <h1 class="doc-title"><i class="icon fa fa-paper-plane"></i> Get Started</h1>
                    <div class="meta"><i class="fa fa-clock-o"></i> Last updated: Dec 31th, 2016</div>
                </div><!--//doc-header-->
                <div class="doc-body">
                    <div class="doc-content">
                        <div class="content-inner">
                            <section id="purpose-section" class="doc-section">
                                <h2 class="section-title">Purpose</h2>
                                <div class="section-block">
                                    <p>From the beginning of time, it seems, the community has viewed Microsoft as anti-OpenSource. The purpose of this project is multi-fold. The first goal was to deliver a solution by Microsoft at it's public Ignite event that was built using OpenSource technologies.  Therefore, instead of using some flavor of .NET and/or Windows IoT Core, I chose to use offerings such as Node.js, Angular 2.0 and MongoDB. 
                                    </p>
                                    <p>The second purpose of this project was to facilitate the adoption of Microsoft Azure by enterprise community members who were already engaged in OpenSource projects. I wished to accomplish this by demonstrating the ease of moving the applications from an environment such as Heroku to an Azure cloud platform such as Service Fabric and to swap the data repository from MongoDB to DocumentDB.  The objective was to perform these "migrations" with as little configuration changes as possible. 
                                    </p>
                                    <p>Finally, instead of talking about this process through concepts delivered by PowerPoint, I wanted to provide an application based on a real-world scenario. The application could be utilized by the community as a starter package in which others could contribute or use for their own projects. The scenario, in our case, is managing and tracking assets.
                                    </p>
                                </div>
                            </section><!--//doc-section-->
                            <section id="download-section" class="doc-section">
                                <h2 class="section-title">Download</h2>
                                <div class="section-block">
                                    <p>There are two downloads options available. 
                                    </p>
                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                        <h6>Complete Source</h6>
                                        <p style="padding-bottom:90px;">The downloadable archive has the source code for the web application and the IoT client application.</p>
                                        <a href="https://github.com/a11smiles/IoT-Asset-Management/archive/master.zip" class="btn btn-green" target="_blank"><i class="fa fa-cloud-download"></i> Download Zip</a>
                                    </div>
                                    <div class="col-md-6 col-sm-6 col-xs-12">
                                        <h6>Raspbian Only</h6>
                                        <p>The Raspbian image is a pre-configured, 8GB image for the Raspberry Pi 3 Model B.<br /><br />Note: The image requires <code>Win32DiskImager</code> which can be found <a href="http://sourceforge.net/projects/win32diskimager/" target="_blank">here</a>. Imaging instructions can be found on the Raspberry Pi <a href="https://www.raspberrypi.org/documentation/installation/installing-images/windows.md" target="_blank">website</a>.</p>
                                        <a href="https://github.com/a11smiles/IoT-Asset-Management/raw/gh-pages/downloads/IoT-Asset-Management.zip" class="btn btn-green" target="_blank"><i class="fa fa-cloud-download"></i> Download Raspbian Image</a>
                                    </div>
                                    <p>&nbsp;</p>
                                </div>
                            </section><!--//doc-section-->
                            <section id="prerequisites-section" class="doc-section">
                                <h2 class="section-title">Prerequisites</h2>
                                <div class="section-block">
                                    <p>While the applications may run in other environments, the demo at Ignite was based on the prerequisites for the two components or this project:
                                    </p>
                                    <div class="row">
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <h5>Web Application</h5>
                                            <ul class="list">
                                                <li>Heroku (and/or Azure)</li>
                                                <li>MongoDB and/or DocumentDB</li>
                                                <li>Azure IoT Hub</li>
                                                <li>Azure Stream Analytics</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6 col-sm-6 col-xs-12">
                                            <h5>Client Application</h5>
                                            <ul class="list">
                                                <li>Raspberry PI 3 Model B</li>
                                                <li><a href="http://store.radiusnetworks.com/collections/all/products/radbeacon-dot" target="_blank">RadBeacon Dot</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </section><!--//doc-section-->
                            <section id="installation-section" class="doc-section">
                                <h2 class="section-title">Installation - Basics</h2>
                                <div class="section-block">
                                    <p>The purpose of this section is to help you prepare the required platforms for hosting the web application and client (Raspberry Pi) application. Keep in mind that the ultimate goal of this project was to demonstrate Microsoft's adoption of OpenSource and Azure's ability to host it. Therefore, the steps below concerning MongoDB and Heroku are completely optional and are denoted as such.
                                    </p>
                                </div>
                                <div id="download-source-basics" class="section-block">
                                    <h3 class="block-title">Download Source</h3>
                                    <p>Download the project using git <code>git clone https://github.com/a11smiles/IoT-Asset-Management.git</code>. <br/><br/>Once the project is downloaded, there are two separate folders: 
                                    </p>
                                    <div class="code-block">
                                        <ul class="list">
                                        <li><code>/pi</code> - contains the client application deployed to a Raspberry Pi</li>
                                        <li><code>/webapp</code> - the Node.js/Angular 2.0 web site</li>
                                        </ul>
                                    </div><!--//code-block-->
                                </div><!--//section-block-->
                                <div id="mongodb-setup" class="section-block">
                                    <h3 class="block-title">MongoDB <em>(Optional)</em></h3>
                                    <p>For demonstration purposes, I used <a href="https://mlab.com/" target="_blank">mlab.com</a> to host my sample main repository. This repository is responsible for storing application users and managed assets. If you don't currently have an available MongoDB database (including locally hosted) and would like to test it's capabilities, mlab.com is a great, <em>free</em> choice.
                                    </p>
                                    <p>Let's go ahead and create a sample database for our application so, first, go create a free account and confirm your email address. Now, follow the steps below to create your database and access credentials.</p>
                                    <ol class="list">
                                        <li>On the dashboard, click "Create New".<br /><br /><img src="assets/images/mlab-create-new.JPG" style="width:75%;" />
                                        </li>
                                        <li>For creating a new deployment, select a "Single-node" plan within a "Sandbox" environment.<br /><br /><img src="assets/images/mlab-sandbox-plan.JPG" style="width:65%;" />
                                        </li>
                                        <li>Enter a database name and click "Create new MongoDB deployment".
                                        </li>
                                        <li>You'll then be returned to your deployments dashboard, showing your newly created database.
                                        </li>
                                        <li>Click on your new database.
                                        </li>
                                        <li>The details page should not have any "Collections" listed for your database, obviously, because you've just created the database. We do <em>not</em> have to create one manually now as our collections will be automatically created with our first documents.
                                        </li>
                                        <li>We do need to create an account by which to connect to our database. NOTE: We do not connect to our database using our mlab.com account. Instead we add individual users and their role to our specific databases.
                                        </li>
                                        <li>Click on the "Users" tab and click "Add database user."<br /><br /><img src="assets/images/mlab-new-database-user.JPG" style="width:75%;" />
                                        </li>
                                        <li>In the popup dialog, enter a database username and password. Leave "Make read-only" <em>unchecked</em>.<br />
                                        For me, I entered the following information:<br /><br />
                                        Username: <strong>testadmin</strong><br />
                                        Password: <strong>testpassword</strong>
                                        </li>
                                        <li>Once I created the user and by observing the configuration at the top of the database configuration page, I can now connect to my hosted MongoDB by using the following URI:<br /><br />
                                            <code>mongodb://testadmin:testpassword@ds019946.mlab.com:19946/iot-assets</code><br /><br />
                                        </li>
                                    </ol>
                                    <div class="callout-block callout-info">
                                        <div class="icon-holder">
                                            <i class="fa fa-info-circle"></i>
                                        </div><!--//icon-holder-->
                                        <div class="content">
                                            <h4 class="callout-title">NOTE</h4>
                                            <p>Your URI may be different depending on what you used for your username, password, database name and the hostname for the machine that's hosting your database. But, it should look similar to mine.</p>
                                        </div><!--//content-->
                                    </div>
                                </div><!--//section-block-->
                                <div id="heroku-setup" class="section-block">
                                    <h3 class="block-title">Heroku <em>(Optional)</em></h3>
                                    <p>As many enterprises are regularly using <a href="http://heroku.com" target="_blank">Heroku</a> for hosting their Node.js applications, I, again, wanted to do the same. As stated earlier, this step is optional.
                                    </p>
                                    <p>In order to host our application we'll need to create an "app" in Heroku so, first, go create a free account and confirm your email address. Now, follow the steps below to setup the hosting environment for our Node.js application.</p>
                                    <ol class="list">
                                        <li>On the dashboard, click "New", then "Create new app".<br /><br /><img src="assets/images/heroku-create-app.JPG" />
                                        </li>
                                        <li>Give your application a name and click "Create App".
                                        </li>
                                    </ol>
                                    <div class="callout-block callout-info">
                                        <div class="icon-holder">
                                            <i class="fa fa-info-circle"></i>
                                        </div><!--//icon-holder-->
                                        <div class="content">
                                            <h4 class="callout-title">NOTE</h4>
                                            <p>Whatever you name your application will be the hostname within your app's URI. (i.e. http://<em>my-app-name</em>.herokuapp.com)</p>
                                        </div><!--//content-->
                                    </div>
                                </div><!--//section-block-->
                                <div id="azure-documentdb" class="section-block">
                                    <h3 class="block-title">Azure DocumentDB</h3>
                                    <p>DocumentDB is Microsoft Azure's NoSQL database platform. It will serve two purposes within our application. 
                                    </p>
                                    <p>First, DocumentDB, if we choose to use it instead of MongoDB, will serve as our main repository to hold our application's users and assets.  Because Microsoft Azure provides a MongoDB connector for DocumentDB, it is very easy to switch between the two databases.
                                    </p>
                                    <p>DocumentDB will also be the repository that holds all of our location data for our Bluetooth LE (RadBeacon) devices. Azure's IoT Hub coupled with Stream Analytics will pass the data into DocumentDB.
                                    </p>
                                    <div class="callout-block callout-danger">
                                        <div class="icon-holder">
                                            <i class="fa fa-exclamation-triangle"></i>
                                        </div><!--//icon-holder-->
                                        <div class="content">
                                            <h4 class="callout-title">MongoDB Connector for DocumentDB</h4>
                                            <p>Currently, the MongoDB connector for Azure's DocumentDB is in preview. Thus, there is some reduced functionality by using DocumentDB for the <em>main</em> database. This can affect performance and security. Until the connector has greater compatibility and enters "General Availability," it is recommended that MongoDB is used for the main repository. 
                                            </p>
                                        </div><!--//content-->
                                    </div>
                                    <p>If you haven't done so already, create an Azure account at <a href="https://azure.microsoft.com/" target="_blank">https://azure.microsoft.com/</a>. Then, login to your portal to begin.
                                    </p>
                                    <ol class="list">
                                        <li>Once you've logged into your Azure portal, on the left you will find see a menu (it could be collapsed). Click on the <img src="assets/images/azure-new-plus.JPG" style="width:25px;" /> to create a new resource.</li>
                                        <li>In the "<em>Search the marketplace</em>" box, search for <strong>DocumentDB</strong>. You will be presented with two options in the search assist as you see in the below image.<br /><br />
                                            <img src="assets/images/documentDB-search.jpg" style="width:235px;" />
                                        </li>
                                    </ol>
                                    <div class="callout-block callout-info">
                                        <div class="icon-holder">
                                            <i class="fa fa-exclamation-triangle"></i>
                                        </div><!--//icon-holder-->
                                        <div class="content">
                                            <h4 class="callout-title">DocumentDB vs. DocumentDB - Protocol Support for MongoDB</h4>
                                            <p>As stated in the above warning, DocumentDB - <em>Protocol Support for MongoDB</em> offers support to use DocumentDB with native MongoDB client libraries.  If you'd like to use DocumentDB for the primary repository - or even test its functionality - then you'll need to create a DocumentDB with support for the MongoDB protocol. If you'd prefer to stick with MongoDB as the primary repository, then choose DocumentDB without support for the MondDB.  Below are the options for each type of DocumentDB repository.
                                            </p>
                                        </div><!--//content-->
                                    </div>
                                    <h6>DocumentDB - IoT Repository Only</h6>
                                    <p>Follow these steps to set up the repository that is only used by the reporting IoT devices.
                                    </p>
                                    <ol class="list">
                                        <li>Select "DocumentDB (NoSQL)". <em>NOTE: You may have to choose this twice.</em></li>
                                        <li>In the resulting pane, click "Create"</li>
                                        <li>You'll then need to complete the template options to configure your DocumentDB instance.
                                            <ul class="list">
                                                <li><strong>ID</strong> - A globally unique name that defines your DocumentDB's namespace (URL).</li>
                                                <li><strong>NoSQL API</strong> - Choose "DocumentDB"</li>
                                                <li><strong>Subscription</strong> - Choose an active Azure subscription</li>
                                                <li><strong>Resource Group</strong> - Choose to either create a new resource group or select a pre-existing one</li>
                                                <li><strong>Location</strong> - Choose a location that's closest to you.</li>
                                            </ul>
                                        </li>
                                        <li>Click "Create"</li>
                                    </ol>
                                    <br />
                                    <h6>DocumentDB - IoT &amp; Primary Repository</h6>
                                    <p>You should only follow these instructions if you wish the test DocumentDB's support for the MongoDB protocol for the application's primary repository.
                                    </p>
                                    <ol class="list">
                                        <li>Select "DocumentDB (NoSQL) - Protocol Support for MongoDB". <em>NOTE: You may have to choose this twice.</em></li>
                                        <li>In the resulting pane, click "Create"</li>
                                        <li>You'll then need to complete the template options to configure your DocumentDB instance.
                                            <ul class="list">
                                                <li><strong>ID</strong> - A globally unique name that defines your DocumentDB's namespace (URL).</li>
                                                <li><strong>NoSQL API</strong> <em>(if available)</em> - Choose "MongoDB".</li>
                                                <li><strong>Subscription</strong> - Choose an active Azure subscription.</li>
                                                <li><strong>Resource Group</strong> - Choose to either create a new resource group or select a pre-existing one.</li>
                                                <li><strong>Location</strong> - Choose a location that's closest to you.</li>
                                            </ul>
                                        </li>
                                        <li>Click "Create"</li>
                                    </ol>
                                </div><!--//section-block-->
                                <div id="documentdb-collections" class="section-block">
                                    <h3>DocumentDB Collections</h3>
                                    <p>The DocumentDB database you created in the previous section will host our various document collections.
                                    </p>
                                    <br />
                                    <h6>Pi Messages Collection</h6>
                                    <p>The Pi Messages collection is responsible for storing all of our incoming messages (i.e. bluetooth beacon locations) from our Raspberry Pi's.</p>
                                    <ol class="list">
                                        <li>In Azure, open your DocumentDB pane.<br /><br />
                                            <img src="assets/images/iot-assets-documentdb.JPG" style="width:75%;" />
                                        </li>
                                        <li>In the top of the pane, click on "Add Collection"</li>
                                        <li>In the Add Collection pane, enter the following information:
                                            <ul class="list>">
                                                <li><strong>Collection Id</strong> - The name of your document collection.  Enter <strong>raspberry</strong>.</li>
                                                <li><strong>Pricing Tier</strong> - Choose a pricing tier for your collection.  In production, this will need to be pretty high in order to have the ability to process and store incoming messages.  In test, you can choose a smaller instance size. </li>
                                                <li><strong>Database</strong> - Choose "Create New" and enter <strong>messages</strong>.</li>
                                            </ul>
                                        </li>
                                        <li>Click "OK"</li>
                                    </ol>
                                    <p>You now have the messages document repository created.
                                    </p>
                                    <br />
                                    <h6>Web Application Collection <em>(Optional)</em></h6>
                                    <p>The web application collection is optional and should only be used if you 1) do not wish to use MongoDB as your main repository; and 2) you've created your DocumentDB with the MongoDB protocol option.</p>
                                    <ol class="list">
                                        <li>In Azure, open your DocumentDB pane.</li>
                                        <li>In the top of the pane, click on "Add Collection"</li>
                                        <li>In the Add Collection pane, enter the following information:
                                            <ul class="list>">
                                                <li><strong>Collection Id</strong> - The name of your document collection.  Enter <strong>assets</strong>.</li>
                                                <li><strong>Pricing Tier</strong> - Choose a pricing tier for your collection.  This isn't a high performing database, so a smaller instance is sufficient.</li>
                                                <li><strong>Database</strong> - Choose "Create New" and enter <strong>app</strong>.</li>
                                            </ul>
                                        </li>
                                        <li>Click "OK"</li>
                                    </ol>
                                    <p>Repeat the above steps to create also collection with an ID of <strong>users</strong> and use the database you just created, named <strong>app</strong>.
                                    </p>
                                </div><!--//section-block-->
                                <div id="iot-hub" class="section-block">
                                    <h3>IoT Hub</h3>
                                    <p>The IoT Hub serves as the receiving endpoint for all incoming messages from the Pi.  Unlike a typical web service, with IoT Hub, things like scalability and failover are baked in.  IoT Hub can handle 100,000+ requests/sec.
                                    </p>
                                    <ol class="list">
                                        <li>In Azure, create a new IoT Hub resource.</li>
                                        <li>In the add IoT Hub pane, enter a name for your IoT Hub (e.g. NodeHub).</li>
                                        <li>With the exception of the Resource Group and Location, you can accept the defaults. This tutorial won't cover the details regarding scaling, units and partitions.</li>
                                        <li>Click "Create"</li> 
                                    </ol>
                                    <p>It may take a little bit to create the IoT Hub, so be patient.<br /><br />Once the IoT Hub creation process has finished, we need to define an access policy so that our Stream Analytics job can connect and read data.</p>
                                    <ol class="list">
                                        <li>While in the Iot Hub pane (open it if it's not open already), click on "Shared access policies".</li>
                                        <li>In the Shared access policies pane, click "Add" on the top menu.</li>
                                        <li>Name the access policy (e.g. iothubowner) and check <em>all four</em> permissions.</li>
                                        <li>Click "Create".</li>
                                    </ol>
                                </div><!--//section-block-->
                                <div id="stream-analytics" class="section-block">
                                    <h3>Stream Analytics</h3>
                                    <p>Stream analytics acts as a middleware processor for our data.  It, itself, really doesn't do anything to our data.  Instead, it relies on other functionality within Azure.  Stream analytics simply gives us the mechanism to "hook up" Azure components to our middleware.
                                    </p>
                                    <ol class="list">
                                        <li>In Azure, create a new Stream Analytics Job resource.</li>
                                        <li>From a creation perspective, the only things required are a name (e.g. iot-assets) and the resource group/location.  Go ahead and fill those in.</li>
                                        <li>Click "Create" when finished.</li>
                                    </ol>
                                    <p>As with the IoT Hub, it may take a few minutes to create the Stream Analytics job. Once it has been created, we need to wire the necessary Azure features into the pipeline. There are three major parts to this exercise: 1) the <strong>Inputs</strong>; 2) the <strong>Query</strong>; and, 3) the <strong>Outputs</strong>. See the below image.<br />
                                    <img src="assets/images/iot-assets-stream-analytics.JPG" style="width:75%;margin:20px auto;" /><br /> Let's configure each one of these. Before we begin, make sure that your job isn't running.  It shouldn't be because we've not yet defined inputs and outputs, but verify in case you've already completed these steps and you're attempting the modify the settings. Also, we'll need to configure the inputs and outputs first before we complete the query.</p>
                                    <br />
                                    <h6>Inputs</h6>
                                    <ol class="list">
                                        <li>While in the Stream Analytics job pane, click on "Inputs" in the either the side menu or the tile.</li> 
                                        <li>In the Input pane, click "Add" on the top menu.</li>
                                        <li>For the new input:
                                            <ul class="list">
                                                <li>Enter an alias (e.g. iot-hub-input)</li>
                                                <li><strong>Source Type</strong> - Data stream</li>
                                                <li><strong>Source</strong> - IoT hub</li>
                                                <li><strong>Subscription</strong> - your subscription</li>
                                                <li><strong>IoT Hub</strong> - NodeHub (or whatever you named it above)</li>
                                                <li><strong>Endpoint</strong> - Messaging</li>
                                                <li><strong>Shared access policy name</strong> - iothubowner (or whatever you named it above)</li>
                                                <li><strong>Consumer group</strong> - $Default</li>
                                                <li><strong>Event serialization format</strong> - JSON</li>
                                                <li><strong>UTF-8</strong></li>
                                            </ul></li>
                                        <li>Click "Create"</li>
                                    </ol>
                                    <br />
                                    <h6>Outputs</h6>
                                    <ol class="list">
                                        <li>While in the Stream Analytics job pane, click on "Outputs" in the either the side menu or the tile.</li> 
                                        <li>In the Input pane, click "Add" on the top menu.</li>
                                        <li>For the new input:
                                            <ul class="list">
                                                <li>Enter an alias (e.g. docdb-output)</li>
                                                <li><strong>Sink</strong> - DocumentDB</li>
                                                <li><strong>Subscription</strong> - your subscription</li>
                                                <li><strong>Account id</strong> - iot-assets (or whatever you named it above)</li>
                                                <li><strong>Database</strong> - messages (or whatever you named it above)</li>
                                                <li><strong>Collection name pattern</strong> - raspberry</li>
                                                <li><strong>Document id</strong> - <em>***leave blank***</em></li>
                                            </ul></li>
                                        <li>Click "Create"</li>
                                    </ol>
                                    <br />
                                    <h6>Query</h6>
                                    <ol class="list">
                                        <li>While in the Stream Analytics job pane, click on "Query" in the either the side menu or the tile.</li> 
                                        <li>In the query editor pane, enter the following:<br /><br />
                                            <pre><code>SELECT
    *
INTO
    [docdb-output]
FROM
    [iot-hub-input]
                                            </code></pre>
                                        </li>
                                        <li>Click "Save" on the top menu and close the pane.</li>
                                    </ol>
                                    <br />
                                    <p>You can now start the Stream Analytics job by clicking on "<strong>Start</strong>" on the Stream Analytics pane.</p>
                                </div><!--//section-block-->
                            </section>
                            <section id="raspberry-section" class="doc-section">
                                <h2 class="section-title">Installation - Raspberry Pi</h2>
                                <div class="section-block">
                                    <p>This section is to assist you with setting up and configuring your Raspbian Pi. The setup is based on a Raspberry Pi 3 Model B.  If you downloaded the pre-configured image from above (e.g. not building from a virgin Raspbian Pi image), then you may skip this section and move to the <a href="#configuration-section">configuration section</a> for the actual client applications.
                                    </p>
                                </div><!--//section-block-->
                                <div id="node"  class="section-block">
                                    <h3 class="block-title">Node and NPM</h3>
                                    <p>The Raspbian Jessie image comes pre-installed with Node v0.10.29.  However, NPM is not installed.  In order to download dependencies, we're going to need to: 1) upgrade Node; and, 2) install NPM.
                                    </p>
                                    <ol class="list">
                                        <li>Download package lists to check for available upgrades<br /><br /><code>sudo apt update</code><br /><br /></li>
                                        <li>Install Node (v4.5.0) and NPM (v2.15.19)<br /><br />
                                            <code>
                                                wget https://nodejs.org/dist/v4.5.0/node-v4.5.0-linux-armv7l.tar.gz<br />
                                                sudo mv node-v4.5.0-linux-armv7l.tar.gz /opt<br />
                                                cd /opt<br />
                                                sudo tar -xzf node-v4.5.0-linux-arm7l.tar.gz<br />
                                                sudo mv node-v4.5.0-linux-arm7l nodejs<br />
                                                sudo rm node-v4.5.0-linux-arm7l.tar.gz<br />
                                                sudo rm /usr/bin/node<br />
                                                sudo ln -s /opt/nodejs/bin/node /usr/bin/node<br />
                                                sudo ln -s /opt/nodejs/bin/npm /usr/bin/npm
                                            </code>
                                        </li>
                                    </ol>
                                </div><!--//section-block-->
                                <div id="ibeacon"  class="section-block">
                                    <h3 class="block-title">iBeacon Location Packages</h3>
                                    <p>The iBeacon location packages allows your Pi to communicate with iBeacon devices and understand their specific payload. 
                                    </p>
                                    <code>sudo apt-get install bluez-hcidump</code>
                                </div><!--//section-block-->
                                <div id="bluez"  class="section-block">
                                    <h3 class="block-title">Bluez Libraries</h3>
                                    <p>The Bluez libraries are a dependency library written in C++ that provides connectivity to Bluetooth LE (low-energy) devices.
                                    </p>
                                    <ol class="list">
                                        <li>Install Dependencies<br /><br />
                                            <code>
                                                sudo apt-get install -y libusb-dev libdbus-1-dev libglib2.0-dev libudev-dev libical-dev libreadline-dev
                                            </code><br /><br />
                                        </li>
                                        <li>Download Libraries<br /><br />
                                            <code>
                                                wget http://www.kernel.org/pub/linux/bluetooth/bluez-5.41.tar.xz<br />
                                                sudo tar -xvf bluez-5.41.tar.xz<br />
                                                cd bluez-5.41
                                            </code><br /><br />
                                        </li>
                                        <li>Compile &amp; Install<br /><br />
                                            <code>
                                                sudo ./configure<br />
                                                sudo make<br />
                                                sudo make install<br />
                                            </code><br /><br />
                                        </li>
                                        <li>Setup Bluez Service<br /><br />
                                            <code>
                                                systemctl status bluetooth
                                            </code><br /><br />
                                            You'll likely see the bluez service is loaded but not active:<br /><br />
                                            <code>
                                                ● bluetooth.service - Bluetooth service<br />
                                                &nbsp;&nbsp;&nbsp;Loaded: loaded (/lib/systemd/system/bluetooth.service; disabled)<br />
                                                &nbsp;&nbsp;&nbsp;Active: inactive (dead)<br />
                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Docs: man:bluetoothd(8)
                                            </code><br /><br />
                                            You can manually start the bluez service by running the following command:<br /><br />
                                            <code>
                                                sudo systemctl start bluetooth
                                            </code><br /><br />
                                            After running the above, run the status command again and you should see the service is now active:<br /><br />
                                            <code>
                                                ● bluetooth.service - Bluetooth service<br />
                                                &nbsp;&nbsp;&nbsp;Loaded: loaded (/lib/systemd/system/bluetooth.service; disabled)<br />
                                                &nbsp;&nbsp;&nbsp;Active: active (running) since Mon 2016-02-29 04:56:27 UTC; 1s ago<br />
                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Docs: man:bluetoothd(8)<br />
                                                &nbsp;Main PID: 715 (bluetoothd)<br />
                                                &nbsp;&nbsp;&nbsp;Status: "Running"<br />
                                                &nbsp;&nbsp;&nbsp;CGroup: /system.slice/bluetooth.service<br />
                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└─715 /usr/local/libexec/bluetooth/bluetoothd
                                            </code><br /><br />
                                            You can stop the service by running:<br /><br />
                                            <code>
                                                sudo systemctl start bluetooth
                                            </code><br /><br />
                                        </li>
                                    </ol>
                                    <div class="callout-block callout-info">
                                        <div class="icon-holder">
                                            <i class="fa fa-info-circle"></i>
                                        </div>
                                        <div class="content">
                                            <h4 class="callout-title">Automatically Starting the Bluetooth Service on Boot</h4>
                                            If you want the bluez serice to run automatically when the Raspberry Pi boots.  To enable the bluez service to run at boot, execute the following command:<br /><br />
                                            <code>
                                                sudo systemctl enable bluetooth
                                            </code><br /><br />
                                            If you ever need to disable it, substitute <code>enable</code> with <code>disable</code> on the previous command.
                                        </div>
                                    </div>
                                </div><!--//section-block-->
                                <div id="enable-bluetooth-le"  class="section-block">
                                    <h3 class="block-title">Enable Bluetooth LE</h3>
                                    <p>The final step to installation is enable the bluetooth low energy features in bluez.  These features are disabled by default because they are still under development and have been placed behind an experimental flag.
                                    </p>
                                    <ol class="list">
                                        <li>To enable the bluez experimental features like LE, you need to modify the service configuration.<br /><br /><code>sudo nano /lib/systemd/system/bluetooth.service</code><br /><br /></li>
                                        <li>You should see a configuration file similary to the following:<br /><br />
                                            <code>
                                                [Unit]<br />
                                                Description=Bluetooth service<br />
                                                Documentation=man:bluetoothd(8)<br />
                                                ConditionPathIsDirectory=/sys/class/bluetooth<br />
<br />
                                                [Service]<br />
                                                Type=dbus<br />
                                                BusName=org.bluez<br />
                                                ExecStart=/usr/local/libexec/bluetooth/bluetoothd   <br />            
                                                NotifyAccess=main<br />
                                                #WatchdogSec=10<br />
                                                #Restart=on-failure<br />
                                                CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE<br />
                                                LimitNPROC=1<br />
<br />
                                                [Install]<br />
                                                WantedBy=bluetooth.target<br />
                                                Alias=dbus-org.bluez.service<br />
                                            </code><br /><br />
                                        </li>
                                        <li>To enable the experimental features, add <strong>--experimental</strong> to the ExecStart line:<br /><br />
                                            <code>
                                                [Unit]<br />
                                                Description=Bluetooth service<br />
                                                Documentation=man:bluetoothd(8)<br />
                                                ConditionPathIsDirectory=/sys/class/bluetooth<br />
<br />
                                                [Service]<br />
                                                Type=dbus<br />
                                                BusName=org.bluez<br />
                                                ExecStart=/usr/local/libexec/bluetooth/bluetoothd <span style="color:lightgreen;">--experimental</span><br />            
                                                NotifyAccess=main<br />
                                                #WatchdogSec=10<br />
                                                #Restart=on-failure<br />
                                                CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE<br />
                                                LimitNPROC=1<br />
<br />
                                                [Install]<br />
                                                WantedBy=bluetooth.target<br />
                                                Alias=dbus-org.bluez.service<br />                                                
                                            </code><br /><br />
                                        </li>
                                        <li>Save the file and exit the editor by pressing <strong>Ctrl-o, enter,</strong> then <strong>Ctrl-x</strong>.</li>
                                        <li>Now tell systemd to reload its configuration files by running:<br /><br /><code>sudo systemctl daemon-reload</code><br /><br /></li>
                                        <li>If the bluez service was previously running, you'll want to restart it by running:<br /><br /><code>sudo systemctl restart bluetooth</code><br /><br />
                                        Or, if the service wasn't running you can start it with the command above.</li>
                                        <li>Once the bluez service is running, you can check that the experimental features are enabled by running the status command again. This time, you should see the <strong>--experimental</strong> flag set on the service:<br /><br />
                                            <code>
                                                ● bluetooth.service - Bluetooth service<br />
                                                &nbsp;&nbsp;&nbsp;Loaded: loaded (/lib/systemd/system/bluetooth.service; disabled)<br />
                                                &nbsp;&nbsp;&nbsp;Active: active (running) since Mon 2016-02-29 04:56:27 UTC; 1s ago<br />
                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Docs: man:bluetoothd(8)<br />
                                                &nbsp;Main PID: 715 (bluetoothd)<br />
                                                &nbsp;&nbsp;&nbsp;Status: "Running"<br />
                                                &nbsp;&nbsp;&nbsp;CGroup: /system.slice/bluetooth.service<br />
                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└─715 /usr/local/libexec/bluetooth/bluetoothd --experimental
                                            </code><br /><br />   
                                        </li>                                            
                                    </ol>
                                </div><!--//section-block-->
                            </section><!--//doc-section-->
                            <section id="configuration-section" class="doc-section">
                                <h2 class="section-title">Configuration</h2>
                                <div class="section-block">
                                    <p>Now that the web application has been downloaded and the Raspberry Pi dependencies have been installed, we need to configure both applications.  The good news is that this section is very simple - the tedious requirements have been completed.
                                    </p>
                                </div><!--//section-block-->
                                <div id="webapp-config" class="section-block">
                                    <h3 class="block-title">Web Application</h3>
                                    <p>To setup up the web application, you will need to set a few simple variables.
                                    </p>
                                    <p>Find and open the file <code>/webapp/config.js</code>. In this file, you will find all of the application's variables.  The idea when creating the application was to provide a single point of configuration instead of having to modify multiple files. Then, change the options as you prefer.
                                    </p>
                                    <ul class="list">
                                        <li><strong>port</strong> - defaults to the applications's environment-configured port or 8080</li>
                                        <li><strong>repo</strong> - the repository type to use (e.g. 'mongodb' or 'documentdb')</li>
                                        <li><strong>mongodb</strong> - the connection string of your mongodb instance</li>
                                        <li><strong>documentdb</strong> - the connection string of your documentdb instance</li>
                                        <li><strong>secret</strong> - a random, secret string that is used to encrypt JSON web tokens</li>
                                        <li><strong>host</strong> - URI for your documentdb instance</li>
                                        <li><strong>masterKey</strong> - 'password' for your documentdb instance</li>
                                    </ul>
                                </div><!--//section-block-->  
                                <div id="pi-config" class="section-block">
                                    <h3 class="block-title">Raspberry Pi</h3>
                                    <p>Configuring the Raspberry Pi is really a simple, two-step process. First, we need to provision the Pi in our Azure tenant.  Then, we'll need to configure the monitoring application with our Pi's provisioned Id.
                                    </p>
                                    <br />
                                    <h6>Registering the Device</h6>
                                    <p>Find and open the file <code>/pi/registerDevice.js</code>. There are 2 lines that you will need to change.
                                    </p>
                                    <ol class="list">
                                        <li>On line 3, you will see <code>device.deviceId = 'mtc-pi01';</code>.  Name your Pi device by changing <em>mtc-pi01</em> to a name you prefer.</li>
                                        <li>Line 5 contains the connection string to your Azure's IoT Hub instance. While you could build this manually, the easiest option is to navigate to your IoT Hub instance in Azure, click on the Shared Access Policy that you created above (e.g. iothubowner) and copy either the <em>Connection string&mdash;primary key</em> or <em>Connection string&mdash;secondary key</em>.</li>
                                        <li>Once you've performed both steps, save the file and exit to the bash prompt.</li>
                                        <li>Run the script: <code>node ./registerDevice.js</code></li>
                                        <li>Upon a successful run of the script, you will see two things printed to the console:
                                            <ol class="list">
                                                <li>Device id</li>
                                                <li>Device key</li>
                                            </ol>
                                        </li>
                                        <li>The device id should be the same as what you entered onto line 3 in step 1. Copy both, the device id and key</li>
                                        <li>That specific Pi has now be registered with IoT Hub.</li>
                                    </ol>
                                    <br />
                                    <h6>Configure the Listener</h6>
                                    <p>Find and open the file <code>/pi/index.js</code>. There is one line that you will need to change.
                                    </p>
                                    <ol class="list">
                                        <li>Line 5 contains the connection string to your Azure's IoT Hub instance <em>for that specific device</em>. Like the connection string from the previous section, it is divided into three components and separated by semi-colons:
                                            <ul class="list">
                                                <li><strong>Hostname</strong> - the host name for you IoT Hub instance (this should be the same as what you copy and pasted as the host name in the previous script - e.g NodeHub.azure-devices.net)</li>
                                                <li><strong>DeviceId</strong> - the device id that you copied from the output in the previous step (also what you entered as the device id in the previous script)</li>
                                                <li><strong>SharedAccessKey</strong> - the device key that you copied from the output in the previous step</li>
                                            </ul>
                                        </li>
                                        <li>Once you've created the connection string (remember, that all three sections should be concatenated and separated by a semi-colon), save the file and exit to the bash prompt.</li>
                                        <li>Run the script: <code>node ./index.js</code></li>
                                        <li>The script will now run in the background, monitor any incoming iBeacon transmittals and push those up to your IoT Hub instance.</li>
                                    </ol>
                                </div><!--//section-block-->
                                <div id="radbeacon-config" class="section-block">
                                    <h3 class="block-title">RadBeacon Dot(s)</h3>
                                    <p>You can now set up multiple RadBeacon Dot(s) to communicate with your Pi.  In order to do so, you'll need to download the RadBeacon application from your phone's marketplace.  Once the configuration application has been downloaded, follow the instructions below.
                                    </p>
                                    <ol class="list">
                                        <li>Open the RadBeacon application on your phone.  You should see an empty list.<br />
                                            <img src="assets/images/rb-list.JPG" style="width:40%;margin:20px auto;" />
                                        </li>
                                        <li>Hold down the on/off switch on the Dot for 3 seconds to put in Dot into configuration mode.  You should see a green light blink twice.</li>
                                        <li>Refresh your phone's screen and you should see the Dot listed. (NOTE: Your ID will be different.)<br />
                                            <img src="assets/images/rb-list-with-beacon.JPG" style="width:40%;margin:20px auto;" />
                                        </li>
                                        <li>Select the listed Dot to open the configuration screen.<br />
                                            <img src="assets/images/rb-config-screen.JPG" style="width:40%;margin:20px auto;" />
                                        </li>
                                        <li>On the configuration screen, you'll see a UUID. The default UUID is the same for <em>all</em> Dots.  You'll need to generate a new one.</li>
                                        <li>You can either type one in manually or select the "Generate UUID" link on the screen.</li>
                                        <li>Optionally, you can increase/decrease the advertising rate and transmit power.
                                            <ul class="list">
                                                <li><strong>Advertising Rate</strong> - how frequently the Dot broadcasts a pulse or heartbeat.</li>
                                                <li><strong>Transmit Power</strong> - increase the distance the Dot will broadcast. Increasing power will allow the Pi to "pick up" the Dot from longer distances, but decreases the Dot's battery life and increases percentage of error.  Decreasing power will reduce the transmission radius of the Dot, but increases the battery life and minimizes the margin of error.</li>
                                            </ul>
                                        </li>
                                        <li>Once you've completed the above steps, choose "Actions" from the menu, then select "Apply" to save your settings.</li>
                                        <li>Reboot your Dot (turn it off, then back on) to allow it to start transmitting.</li>
                                    </ol>
                                </div><!--//section-block-->    
                            </section>
                            <section id="deployment-section" class="doc-section">
                                <h2 class="section-title">Deployment &amp; Last Steps</h2>
                                <div class="section-block">
                                    <p>All configuration steps have been completed. You are now ready to deploy the web application and start monitoring bluetooth beacons.
                                    </p>
                                </div><!--//section-block-->
                                <div id="heroku-deploy" class="section-block">
                                    <h3 class="block-title">Heroku</h3>
                                    <p>While you can also deploy the web application to Azure, Heroku is a nice choice for testing as it offers a completely <em>free</em> tier for Node.js applications. You should have already created the application in Heroku in the steps above. Deploying the project is not very difficult. You can do it via Heroku Git, GitHub or Dropbox. The default setup in Heroku is using Heroku Git, so that's what we'll use.
                                    </p>
                                    <p>One thing to note is that we don't want to <em>push</em> all files in the repository to Heroku, just the contents of the <code>webapp</code> subdirectory.  While we <em>could</em> technically split the folder into a new repository, that may not be our best option if we want to keep all files in the same repository.  So, instead, we'll simply copy the subfolder to it's own directory and <em>push</em> that single directory to Heroku.
                                    </p>
                                    <p>Finally, instead of using pure Git commands, Heroku provides a nice CLI that makes things super easy for us.
                                    </p>
                                    <ol class="list">
                                        <li>Visit <a href="https://devcenter.heroku.com/articles/heroku-cli" target="_blank">Heroku</a> to download and install the Heroku CLI. (You may be required to reboot.)</li>
                                        <li>Copy the <code>webapp</code> folder to another folder that is <em>outside</em> of the parent project folder. (Because there are many different OS's, I'll let you decide how you want to do that.)</li>
                                        <li>Initialize the folder as a Git repository<br /><br /><code>git init</code><br /><br /></li>
                                        <li>Login to Heroku using the CLI<br /><br /><code>heroku login</code><br /><br /></li>
                                        <li>Add Heroku as a remote repository using the CLI, replacing <em>&lt;your app name&gt;</em> with the name of the application you created in Heroku above<br /><br /><code>heroku git:remote -a <em>&lt;your_app_name&gt;</em></code><br /><br /></li>
                                        <li>Heroku requires a special file to know how to run your application:
                                            <ol class="list">
                                                <li>In the <code>webapp</code> home directory, create a file named <code>Procfile</code> (case-sensitive).</li>
                                                <li>Add the following code to the first line of the file and save the file.<br /><br /><code>web: node server.js</code></br><br /></li>
                                            </ol>
                                        </li>
                                        <li>Now, let's commit the application to Heroku by entering the following commands.<br /><br />
                                            <code>
                                                git add .<br />
                                                git commit -m "initial commit"<br />
                                                git push
                                            </code><br /><br /></li>
                                    </ol>
                                </div>
                                <div id="ibeacon-monitoring" class="section-block">
                                    <h3 class="block-title">iBeacon Monitoring</h3>
                                    <p>The Raspberry Pi('s) need to monitor for iBeacon broadcasts and transmit that data up to Azure. Because we've already configured the Pi('s) earlier, all we need to do is start the monitoring service.
                                    </p>
                                    <ol class="list">
                                        <li>In the application folder (e.g. pi), run the following command<br /><br /><code>node ./index.js</code><br /><br /></li>
                                    </ol>
                                    <p>Once the iBeacons start transmitting, you'll need to add an asset to the application and enter the UUID of the iBeacon for the asset's UUID to start seeing data in the web application.
                                    </p>
                                </div>
                            </section>
                        </div><!--//content-inner-->
                    </div><!--//doc-content-->
                    <div class="doc-sidebar hidden-xs">
                        <nav id="doc-nav">
                            <ul id="doc-menu" class="nav doc-menu" data-spy="affix">
                                <li><a class="scrollto" href="#purpose-section">Purpose</a></li>
                                <li><a class="scrollto" href="#download-section">Download</a></li>
                                <li><a class="scrollto" href="#prerequisites-section">Prerequisites</a></li>
                                <li>
                                    <a class="scrollto" href="#installation-section">Installation - Basics</a>
                                    <ul class="nav doc-sub-menu">
                                        <li><a class="scrollto" href="#download-source-basics">Download Source</a></li>
                                        <li><a class="scrollto" href="#mongodb-setup">MongoDB</a></li>
                                        <li><a class="scrollto" href="#heroku-setup">Heroku</a></li>
                                        <li><a class="scrollto" href="#azure-documentdb">Azure DocumentDB</a></li>
                                        <li><a class="scrollto" href="#documentdb-collections">DocumentDB Collections</a></li>
                                        <li><a class="scrollto" href="#iot-hub">IoT Hub</a></li>
                                        <li><a class="scrollto" href="#stream-analytics">Stream Analytics</a></li>
                                    </ul><!--//nav-->
                                </li>
                                <li>
                                    <a class="scrollto" href="#raspberry-section">Installation - Raspberry Pi</a>
                                    <ul class="nav doc-sub-menu">
                                        <li><a class="scrollto" href="#node">Node and NPM</a></li>
                                        <li><a class="scrollto" href="#ibeacon">iBeacon Location Packages</a></li>
                                        <li><a class="scrollto" href="#bluez">Bluez Libraries</a></li>
                                        <li><a class="scrollto" href="#enable-bluetooth-le">Enable Bluetooth LE</a></li>
                                    </ul><!--//nav-->
                                </li>
                                <li>
                                    <a class="scrollto" href="#configuration-section">Configuration</a>
                                    <ul class="nav doc-sub-menu">
                                        <li><a class="scrollto" href="#webapp-config">Web Application</a></li>
                                        <li><a class="scrollto" href="#pi-config">Raspberry Pi</a></li>
                                        <li><a class="scrollto" href="#radbeacon-config">RadBeacon Dot(s)</a></li>
                                    </ul><!--//nav-->
                                </li>
                                <li>
                                    <a class="scrollto" href="#deployment-section">Deployment &amp; Last Steps</a>
                                    <ul class="nav doc-sub-menu">
                                        <li><a class="scrollto" href="#heroku-deploy">Heroku</a></li>
                                        <li><a class="scrollto" href="#ibeacon-monitoring">iBeacon Monitoring</a></li>
                                    </ul><!--//nav-->
                                </li>                                
                            </ul><!--//doc-menu-->
                        </nav>
                    </div><!--//doc-sidebar-->
                </div><!--//doc-body-->              
            </div><!--//container-->
        </div><!--//doc-wrapper-->        
    </div><!--//page-wrapper-->
    
    <footer id="footer" class="footer text-center">
        <div class="container">
            <!--/* This template is released under the Creative Commons Attribution 3.0 License. Please keep the attribution link below when using for your own project. Thank you for your support. :) If you'd like to use the template without the attribution, you can check out other license options via our website: themes.3rdwavemedia.com */-->
            <small class="copyright">Template designed with <i class="fa fa-heart"></i> by <a href="http://themes.3rdwavemedia.com/" target="_blank">Xiaoying Riley</a> for developers</small>
            
        </div><!--//container-->
    </footer><!--//footer-->
    
     
    <!-- Main Javascript -->          
    <script type="text/javascript" src="assets/plugins/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/plugins/prism/prism.js"></script>    
    <script type="text/javascript" src="assets/plugins/jquery-scrollTo/jquery.scrollTo.min.js"></script>                                                                
    <script type="text/javascript" src="assets/plugins/jquery-match-height/jquery.matchHeight-min.js"></script>
    <script type="text/javascript" src="assets/js/main.js"></script>
    
</body>
</html> 

